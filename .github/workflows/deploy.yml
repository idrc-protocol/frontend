name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy and Update PM2
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script_stop: true
          script: |
            set -e
            cd ${{ secrets.DEPLOY_PATH || '/home/kizovps/idrc/frontend' }}
            
            echo "=========================================="
            echo "Deployment Started"
            echo "=========================================="
            
            # Load NVM first
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            echo "[1/5] Pulling latest changes..."
            git fetch origin 2>&1 | grep -v "^From" | grep -v "^Already" || true
            git pull origin main 2>&1 | grep -v "^Already" || true
            echo "✓ Code updated"
            
            echo "[2/5] Installing dependencies..."
            pnpm install --frozen-lockfile 2>&1 | grep -E "(up to date|progress|Done)" || true
            echo "✓ Dependencies installed"
            
            echo "[3/5] Building application..."
            pnpm build 2>&1 | tail -5
            echo "✓ Build completed"
            
            echo "[4/5] Restarting PM2..."
            pm2 restart idrc-frontend 2>&1 | grep -v "│" | grep -v "┌" | grep -v "└" | grep -v "Process" || true
            pm2 save > /dev/null 2>&1
            echo "✓ PM2 restarted"
            
            echo "[5/5] Verifying deployment..."
            sleep 3
            
            # Check PM2 status without showing sensitive details
            if pm2 jlist 2>/dev/null | jq -r '.[] | select(.name=="idrc-frontend") | .pm2_env.status' 2>/dev/null | grep -q "online"; then
              echo "✅ Deployment successful"
              echo "Application: idrc-frontend is running"
            else
              echo "❌ Deployment verification failed"
              exit 1
            fi
            
            echo "=========================================="
            echo "Deployment Complete"
            echo "=========================================="

  notify:
    name: Notify Status
    needs: [deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Success
        if: needs.deploy.result == 'success'
        run: echo "✅ Deployment successful"
          
      - name: Failed
        if: needs.deploy.result != 'success'
        run: |
          echo "❌ Deployment failed"
          exit 1
